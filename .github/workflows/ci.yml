name: App CI
# Prevent multiple jobs from running at the same time and cancel in-progress runs
concurrency:
  group: ci-${{ github.event_name == 'release' && 'release' || github.ref }}
  # Disable cancelling in-progress runs because sst will lock a deploy, preventing the subsequent deploy from succeeding
  cancel-in-progress: false
on:
  # Run on push to main (dev deployment)
  push:
    branches: [main]
  # Run on release (prod deployment)
  release:
    types: [published]

# Global environment variables
env:
  AWS_REGION: us-east-1
  SST_STAGE: ${{ vars.SST_STAGE }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  POSTHOG_CLI_ENV_ID: ${{ vars.POSTHOG_CLI_ENV_ID }}
  POSTHOG_CLI_TOKEN: ${{ secrets.POSTHOG_CLI_TOKEN }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
  GITHUB_REPO: ${{ github.repository }}
  GITHUB_SHA: ${{ github.sha }}

# The different jobs to run
jobs:
  # ------------- START SETUP -------------
  # Base setup job that installs and caches dependencies (to be re-loaded by our composite setup action)
  setup:
    name: Setup
    runs-on: ubuntu-latest
    steps:
      # Basic setup steps
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      # Cache dependencies
      - name: Set up cache for dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}

      # Install dependencies
      - name: Install dependencies
        run: bun install --ignore-scripts

      # DEBUG: Show lockfile changes
      - name: Show lockfile diff
        run: git diff bun.lock

      # Get SST version
      - name: Get SST version
        id: sst-version
        run: echo "version=$(bun --silent get-package-version --package sst)" >> $GITHUB_OUTPUT

      # Cache SST providers
      - name: Cache SST providers
        uses: actions/cache@v4
        id: cache-sst-providers
        with:
          path: .sst
          key: ${{ runner.os }}-sst-providers-${{ steps.sst-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-sst-providers-

      # Install our SST providers
      - name: Install SST providers
        run: bun sst install

      # Cache indicator for CI initialization (never invalidates unless manually cleared)
      - name: Cache CI initialization indicator
        id: cache-ci-initialized
        uses: actions/cache@v4
        with:
          path: .ci-initialized
          key: sst-ci-initialized

      # Initialize minimal ci stage since SST fails tests if the ci stage does't exist (only runs once)
      - name: Initialize minimal CI stage
        if: steps.cache-ci-initialized.outputs.cache-hit != 'true'
        run: |
          bun sst unlock --stage minimal || true
          SKIP_SOURCEMAPS=true bun sst deploy --stage minimal
          echo "initialized" > .ci-initialized

      # Get Playwright version
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(bun --silent get-package-version --package @playwright/test --path ./apps/web)" >> $GITHUB_OUTPUT

      # Cache Playwright browsers
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: cache-playwright-browsers
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-browsers-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-playwright-browsers-

      # Install Playwright browsers
      - name: Install Playwright browsers
        if: steps.cache-playwright-browsers.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

  # ------------- START TESTING -------------
  # Lint packages for errors and formatting
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        uses: ./.github/actions/setup
        with:
          job-name: lint

      - name: Run lint
        run: bun lint

  # Check for type errors
  typecheck:
    name: Check types
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        uses: ./.github/actions/setup
        with:
          job-name: typecheck

      - name: Run type check
        run: bun types:check

  # Run our standard tests
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        uses: ./.github/actions/setup
        with:
          job-name: test

      - name: Run tests
        run: bun test:ci

  # Run our standard tests
  verify-migrations:
    name: Verify migrations
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        uses: ./.github/actions/setup
        with:
          job-name: verify-migrations

      - name: Run migration validation
        run: bun backend db:migrate:validate

  # Run our E2E tests (only run on releases)
  e2e:
    name: E2E Test
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        uses: ./.github/actions/setup
        with:
          job-name: e2e

      # Cache NextJS build
      - name: Cache NextJS build
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('apps/web/**/*.[jt]s?(x)') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-

      # Cache SST artifacts for CI environment (used for e2e tests)
      - name: Cache SST CI artifacts
        uses: actions/cache@v4
        with:
          path: .sst
          key: ${{ runner.os }}-sst-ci-${{ hashFiles('sst.config.ts', 'infra/**/*.ts') }}
          restore-keys: |
            ${{ runner.os }}-sst-ci-

      # Deploy the "ci" environment for running E2E tests
      - name: Deploy app
        run: |
          bun sst unlock --stage ci
          SKIP_SOURCEMAPS=true bun sst deploy --stage ci

      - name: Run E2E tests
        run: bun web test:e2e

      # Upload artifacts to see results
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30

      - name: Upload Playwright screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: apps/web/test-results/
          retention-days: 30

  # Deploy job that waits for all checks to pass
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, verify-migrations, e2e]
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    if: always() && (needs.lint.result == 'success' && needs.typecheck.result == 'success' && needs.test.result == 'success' && needs.verify-migrations.result == 'success') && (github.event_name != 'release' || needs.e2e.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        uses: ./.github/actions/setup
        with:
          job-name: deploy

      # Cache NextJS build
      - name: Cache NextJS build
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('apps/web/**/*.[jt]s?(x)') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-

      # Cache SST artifacts for dev environment
      - name: Cache SST dev artifacts
        uses: actions/cache@v4
        if: github.event_name != 'release'
        with:
          path: .sst
          key: ${{ runner.os }}-sst-dev-${{ hashFiles('sst.config.ts', 'infra/**/*.ts') }}
          restore-keys: |
            ${{ runner.os }}-sst-dev-

      # Cache SST artifacts for prod environment
      - name: Cache SST prod artifacts
        uses: actions/cache@v4
        if: github.event_name == 'release'
        with:
          path: .sst
          key: ${{ runner.os }}-sst-prod-${{ hashFiles('sst.config.ts', 'infra/**/*.ts') }}
          restore-keys: |
            ${{ runner.os }}-sst-prod-

      # ------------- START DEPLOYMENT -------------
      # Run migrations
      - name: Run migrations
        run: bun backend prisma migrate deploy

      # Deploy main apps using sst
      - name: Deploy app
        run: |
          bun sst unlock
          bun sst deploy
